Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_KAP_Notes_Template((ITEMROOT)KAP_BOOK_AlchemistNotes_faed1c8d-a455-4930-be0b-74f23306f2f6);

DB_KAP_Notes_Header("KAP_Notes_Header");
DB_KAP_Notes_Header_Recipes("KAP_Notes_Header_Recipes");

DB_KAP_Notes(0,"");
KBSECTION
IF
TemplateUseStarted(_User, _Template, _Item)
AND
DB_KAP_Notes_Template(_Template)
AND
QRY_KAP_Setup_Notes((CHARACTER)_User)
AND
DB_KAP_Notes(_,_NotesName)
AND 
NOT DB_OnlyOnce("KAP_Open_Notes")
THEN
DB_OnlyOnce("KAP_Open_Notes");
OpenCustomBookUI(_User,_NotesName);
TimerLaunch("KAP_Wait_Open_Notes", 100);

QRY
QRY_KAP_Setup_Notes((CHARACTER)_User)
AND
QRY_KAP_SetNotesIndex()
AND
DB_KAP_Notes(_, _NotesName)
AND
QRY_KAP_NotesHeader(_User,_NotesName)
AND
QRY_KAP_NotesRecipesHeader(_User,_NotesName)
AND
QRY_KAP_NotesRecipes(_User,_NotesName)
AND
QRY_KAP_NotesTravelEntries(_User,_NotesName)
AND
QRY_KAP_NotesBaseAlchemy(_User,_NotesName)
THEN
SetDualEntityEvent(_User,_User,_NotesName);
DB_NOOP(1);

QRY
QRY_KAP_SetNotesIndex()
AND
DB_KAP_Notes(_Index, _NotesName)
AND
IntegerSum(_Index, 1, _NewIndex)
AND
ConcatenateInteger("KAP_Notes_",_NewIndex,_NewNotesName)
THEN
DB_KAP_Notes(_NewIndex,_NewNotesName);



QRY
QRY_KAP_NotesHeader((CHARACTER)_User,(STRING)_NotesName)
AND
DB_KAP_Notes_Header(_Header)
THEN
AddEntryToCustomBook(_NotesName, _Header);

QRY
QRY_KAP_NotesBaseAlchemy((CHARACTER)_User,(STRING)_NotesName)
THEN
AddEntryToCustomBook(_NotesName, "KAP_Notes_Entry_Base");

QRY
QRY_KAP_NotesTravelEntries((CHARACTER)_User,(STRING)_NotesName)
THEN
DB_NOOP(1);

QRY
QRY_KAP_NotesRecipesHeader((CHARACTER)_User,(STRING)_NotesName)
AND
DB_KAP_Notes_Header_Recipes(_Recipes)
THEN
AddEntryToCustomBook(_NotesName, _Recipes);

QRY
QRY_KAP_NotesRecipes((CHARACTER)_User,(STRING)_NotesName)
AND
DB_KAP_Recipes_Known(_Recipe,_)
THEN
AddEntryToCustomBook(_NotesName, _Recipe);

QRY
QRY_KAP_NotesRecipes((CHARACTER)_User,(STRING)_NotesName)
AND
NOT DB_KAP_Recipes_Known(_,_)
THEN
DB_NOOP(1);


//----------------------------------------------------------------
// TECHNICAL 
//----------------------------------------------------------------
//
// Singleton 
IF
DB_KAP_Notes(_NewIndex, _NewCustomBook)
AND
DB_KAP_Notes(_OldIndex, _OldCustomBook)
AND
_NewIndex != _OldIndex
AND
_NewCustomBook != _OldCustomBook
THEN
NOT DB_KAP_Notes(_OldIndex, _OldCustomBook);



//
// KAP_Wait_Open_Notes
IF
TimerFinished("KAP_Wait_Open_Notes")
AND
DB_OnlyOnce("KAP_Open_Notes")
THEN
NOT DB_OnlyOnce("KAP_Open_Notes");
//
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "GLO_KelaAlchemyProject"
